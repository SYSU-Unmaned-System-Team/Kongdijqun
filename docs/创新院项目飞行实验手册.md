# 创新院项目飞行实验手册

### 飞机硬件组成

- 机架
- 飞行控制器，一般使用Pixhawk4 或 Pixhawk4 Mini
- 机载电脑，妙算2c
- 传感器
  - Hokuyo激光雷达
  - Realsense D435i
  - 单目相机
- 其他配件
  - ttl转usb
  - hdmi欺骗器
  - wifi模块
  - wifi天线

解决妙算端口权限的问题：

```
# 输入以下指令并重启
sudo adduser $USER dialout
```



### 准备工作

- **确认VICON动捕系统**

  - 超过一周未使用请重新校准，标定杆方向（人面向实验场地，标定杆正面朝上，长杆朝左，有vicon字的短杆超前）
  - 刚体名字与代码launch文件一致，注刚体命名不可以数字开头
  - tracker软件设置中已启用推送
  - 如果重新校准后，请一定确认：启动代码后，看到地面站终端显示的位置与Front-Left-Up（FLU）坐标系相符合

- **QGC中完成飞控准备工作**

  - 固件刷写，固件存储路径：Experiment/px4_firmware/firmware_cxy.px4（随着日期会有变动，选择最新日期的固件）

  - 设置X型布局，选择DJI F330机型

  - 传感器校准（包括陀螺仪、加速度计、磁力计、水平面四种校准）

  - 遥控器设置如下（统一使用乐迪AT9s遥控器，长按mode即可进入设置 - 辅助通道）

    - Channel 6：SwA
    - Channel 7：SwB
    - Channel 8：SwE
    - Channel 9：SwF

  - 遥控器校准，需要注意的是右手油门选择模式一（日本手）、左手油门选择模式二（美国手）

  - 飞行模式设置：Mode通道、解锁通道、紧急上锁通道、offboard开关通道

    ![image-20210401100318592](G:\@@@@@@@@工作\Research Files @ SYSU\科研项目\创新院@空地无人集群虚实结合实验平台\项目开发\实验手册.assets\image-20210401100318592.png)

  - 安全设置：设置遥控器丢失和数据链路丢失的failsafe操作

    ![image-20210324152220580](G:\@@@@@@@@工作\Research Files @ SYSU\科研项目\创新院@空地无人集群虚实结合实验平台\项目开发\实验手册.assets\image-20210324152220580.png)

    - 此处设置后，遥控器失联超过0.5秒或offboard控制信号丢失5秒后，无人机会自动停桨；

  - CBRK系列参数参数设置：解除一些解锁设置（如安全开关，无GPS信号等）

    - CBRK_IO_SAFETY设为22027
    - CBRK_BUZZER设为782097
    - CBRK_USB_CHK设为197848
    - CBRK_SUPPLY_CHK设为894281
    - 以上参数的逻辑为：设为0，则无人机解锁时会检查此项；设为最大值，则不检查此项。
    - 以CBRK_IO_SAFETY为例，设为0，若安全开关没有打开，则无人机无法解锁；设为22027，则跳过该检查

  - MAVLink系列参数设置：如果使用机载电脑进行控制，需要设置此项

    - MAV_1_CONFIG设置为TELEM2（Pixhawk4），TELEM/SERIAL4（Pixhawk4 mini）
    - MAV_1_MODE设置为Onboard
    - SER_TEL2_BAUD或SER_TEL4_BAUD设置为指定波特率，一般设置为921600，如果有特
      殊情况可设置为115200

  - EKF2系列参数设置：如果使用外部定位设备，需要设置此项；户外GPS飞行，此项不设置

    - EKF2_AID_MASK设置为24（vision position fusion和 vision yaw fusion）

    - EKF2_HGT_MODE设置为Vision

      <img src="G:\@@@@@@@@工作\Research Files @ SYSU\科研项目\创新院@空地无人集群虚实结合实验平台\项目开发\实验手册.assets\image-20210324152731605.png" alt="image-20210324152731605" style="zoom:50%;" />

  - 姿态控制参数：如果飞机手动飞行时出现抖动需要设置此项

    - 如果飞机出现抖动的情况，一般是调小MC_PITCHRATE_P和MC_ROLLRATE_P即可

  - 位置控制参数：对飞行的速度等进行限制幅度处理，处于安全考虑

    - MPC_THR_HOVER依据实际情况设定（这个是悬停油门，可以通过手动飞行大致确定）
    - MPC_TILTMAX_AIR设置为20deg（这一项可以限定最大倾斜角，即限定速度）
    - MPC_XY_VEL_MAX设置为0.3-0.5m/s（限定水平最大合速度，依据实际情况设定，建议小一点）
    - MPC_Z_VEL_MAX_DN设置为0.5m/s
    - MPC_Z_VEL_MAX_UP设置为0.5m/s
    - 其他位置控制参数依据实际情况设定

  - PWM参数设置

    - PWM_MIN设置为1000
    - PWM_MAX设置为2000
    - 此项应当根据动力系统具体设置

  - offboard丢失的failsafe设置

    - COM_OBL_ACT设置为Land mode
    - COM_OBL_RC_ACT设置为Land mode
    - COM_OF_LOSS_T设置为1s

- **机载电脑准备工作**

  - 开机请设置为自动连入（无需密码进入）
  - wifi网卡确认
    - 部分机载电脑自带wifi模块，如TX2等
    - 研扬系列板卡需要安装wifi模块，可能需要安装驱动
    - 妙算2-c需要购买免驱动的外置wifi网卡
    - 设置连接指定路由器，注意关闭其他wifi的自动连接，**确保开机后自动连接指定路由器**
  - 安装ROS、Mavros、vrpn_client_ros、Kongdijiqun等功能包
  - 安装Intel Realsense驱动
    - https://github.com/amov-lab/Prometheus/wiki/D435i+T265%E5%BB%BA%E5%9B%BE
  - 安装SSH及配置ROS多机
    - https://github.com/amov-lab/Prometheus/wiki/ROS%E5%A4%9A%E6%9C%BA%E5%8F%8ASSH%E6%95%99%E7%A8%8B
    - 本地电脑设置为主机，机载电脑设置为从机
  - 检查px4_sender参数，地理围栏等



### 实验流程

#### 通用流程

**注意事项：**

- 飞机全部断电，摆放至规定位置（单机实验直接放置在vicon原点即可）
- 请保证飞机在平稳状态（即飞机水平放置在地面上）上电
  - 切记不要把飞机翻转过来上电，因为上电瞬间，飞控必须是水平稳定状态

- 实验结束后，请记得一定先断电，再把飞机拿出来！！！

在**本地电脑**中打开如下终端，并运行相关指令

- **终端1**

  - roscore 主节点，此终端建议一直打开，用于主从机的ros主节点

- **终端2**

  - 地面电脑SSH连接机载电脑，启动机载程序，一般为 

    ``` c
    # SSH连接机载电脑，dji为机载电脑用户名，192.168.1.xx为机载电脑IP地址
    ssh dji@192.168.1.xx
    # 连接成功后，启动如下命令
    roslaunch prometheus_experiment cxy_control_onboard.launch
    ```

- **终端3**

  - 启动地面监控及指控程序，一般为

    ``` c
    roslaunch prometheus_experiment cxy_control_ground.launch
    ```

  - 如果是第一次实验，请先检查此时打印的无人机位置是否正确（即确认vicon）

- **终端4**

  - 用于测试连接情况

    ``` c
    ping 192.168.1.xx(从机IP)
    ```

  - 用于ros调试，查看一些话题消息

    ``` c
    rostopic info/echo/hz topic_name
    rosnode info node_name
    ...
    ```

  - 用于查看摄像头图像

    ``` c
    rqt_image_view
    ```

  

#### Case 1 实验流程